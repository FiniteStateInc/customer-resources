{% extends "base.html" %}

{% block title %}Job {{ job.id[:8] }} - Customer Resources Portal{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li><a href="/jobs" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">Jobs</a></li>
            <li class="flex items-center">
                <svg class="w-4 h-4 text-gray-400 mx-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
                <span class="text-gray-900 dark:text-white font-medium font-mono">{{ job.id[:8] }}...</span>
            </li>
        </ol>
    </nav>

    <!-- Job Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6"
         {% if job.status == 'running' or job.status == 'pending' %}
         hx-get="/jobs/{{ job.id }}"
         hx-trigger="every 3s"
         hx-select="#job-content"
         hx-target="#job-content"
         hx-swap="outerHTML"
         {% endif %}>
        <div id="job-content">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ job.tool_name }}</h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400 font-mono">{{ job.id }}</p>
                </div>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                    {% if job.status == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400
                    {% elif job.status == 'running' %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400
                    {% elif job.status == 'failed' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400
                    {% else %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400{% endif %}">
                    {% if job.status == 'running' %}<div class="spinner mr-2"></div>{% endif %}
                    {{ job.status|title }}
                </span>
            </div>

            <!-- Job Metadata -->
            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Created</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                        {{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') if job.created_at else '--' }}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Started</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                        {{ job.started_at.strftime('%Y-%m-%d %H:%M:%S') if job.started_at else '--' }}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Completed</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                        {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') if job.completed_at else '--' }}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Duration</dt>
                    <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                        {% if job.completed_at and job.started_at %}
                        {{ (job.completed_at - job.started_at).total_seconds()|int }}s
                        {% else %}
                        --
                        {% endif %}
                    </dd>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    {% if job.status == 'failed' and job.error_message %}
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
        <div class="flex">
            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error</h3>
                <p class="mt-1 text-sm text-red-700 dark:text-red-300">{{ job.error_message }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Output Files -->
    {% if output_files %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Output Files</h2>
        <div class="space-y-2">
            {% for file in output_files %}
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex items-center gap-3">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">{{ file.name }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ (file.size / 1024)|round(1) }} KB</p>
                    </div>
                </div>
                <a href="/jobs/{{ job.id }}/download/{{ file.name | urlencode }}"
                   hx-boost="false"
                   download="{{ file.name.split('/')[-1] }}"
                   class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                    <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Download
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Logs -->
    {% if job.logs %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Execution Logs</h2>
        <pre class="bg-gray-900 text-gray-100 rounded-lg p-4 overflow-x-auto text-sm font-mono max-h-96 overflow-y-auto">{{ job.logs }}</pre>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="flex items-center justify-between">
        <a href="/jobs" class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
            &larr; Back to Jobs
        </a>
        <div class="flex items-center gap-3">
            <a href="/tools/{{ job.tool_name }}"
               class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                Run Again
            </a>
            <button hx-delete="/jobs/{{ job.id }}"
                    hx-confirm="Are you sure you want to delete this job and all its output files?"
                    hx-redirect="/jobs"
                    class="inline-flex items-center px-4 py-2 border border-red-300 dark:border-red-600 rounded-lg text-sm font-medium text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                Delete Job
            </button>
        </div>
    </div>
</div>
{% endblock %}
