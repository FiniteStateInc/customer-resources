<div class="prerun-panel" id="prerun-panel">
    <div class="prerun-header">
        <h2>{% if workflow_title %}{{ workflow_title }}{% else %}Run Recipes{% endif %}</h2>
        <p class="prerun-recipes">{{ recipe_names | join(', ') }}</p>
        <button class="btn-close prerun-close">&times;</button>
    </div>

    <form id="prerun-submit-form" onsubmit="return false;">
        <input type="hidden" name="recipes" value="{{ recipe_names | join(',') }}">
        <input type="hidden" name="_csrf" value="{{ nonce }}">

        <!-- Run Settings (always shown) -->
        <details open class="form-section">
            <summary class="form-section-title">Run Settings</summary>
            <div class="form-group">
                <label for="pre-period">Period</label>
                <input type="text" id="pre-period" name="period"
                       value="{{ state.get('period', '30d') }}" placeholder="30d, 2m, 90d">
            </div>
            <div class="form-group">
                <label for="pre-output">Output directory</label>
                <div class="input-with-btn">
                    <input type="text" id="pre-output" name="output_dir"
                           value="{{ state.get('output_dir', './output') }}" placeholder="./output">
                    <button type="button" id="pre-output-browse" class="btn btn-sm btn-default">Browse</button>
                </div>
            </div>
            <div class="form-group form-row">
                <label for="pre-overwrite">Overwrite existing</label>
                <label class="toggle">
                    <input type="checkbox" id="pre-overwrite" name="overwrite"
                           {% if state.get('overwrite') %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="form-group">
                <label for="pre-cache-ttl">Cache TTL (hours, 0=off)</label>
                <input type="text" id="pre-cache-ttl" name="cache_ttl"
                       value="{{ state.get('cache_ttl', '4') }}" placeholder="4">
            </div>
        </details>

        <!-- Assessment Scope -->
        <details open class="form-section">
            <summary class="form-section-title">Assessment Scope</summary>
            <div class="form-group">
                <label for="pre-folder">&#128193; Folder filter</label>
                <select id="pre-folder" name="folder_filter"
                        data-value="{{ state.get('folder_filter', '') }}">
                    <option value="">(all folders)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="pre-project">&#128196; Project filter</label>
                <select id="pre-project" name="project_filter"
                        data-value="{{ state.get('project_filter', '') }}">
                    <option value="">(all projects)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="pre-version">&#127991; Version filter</label>
                <select id="pre-version" name="version_filter"
                        data-value="{{ state.get('version_filter', '') }}">
                    <option value="">(all versions)</option>
                </select>
            </div>
            <div class="form-group form-row">
                <label for="pre-cvo">Current version only</label>
                <label class="toggle">
                    <input type="checkbox" id="pre-cvo" name="current_version_only"
                           {% if state.get('current_version_only', True) %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            {% if show_cve %}
            <div class="form-group">
                <label for="pre-cve">CVE ID(s)</label>
                <input type="text" id="pre-cve" name="cve_filter"
                       value="{{ state.get('cve_filter', '') }}"
                       placeholder="CVE-2024-1234, CVE-2024-5678">
            </div>
            {% endif %}

            {% if show_finding_types %}
            <div class="form-group">
                <label for="pre-ft">Finding types</label>
                <input type="text" id="pre-ft" name="finding_types"
                       value="{{ state.get('finding_types', 'cve') }}"
                       placeholder="cve, sast, credentials">
                <small class="form-hint">Types: cve, sast, thirdparty, binary_sca, source_sca. Categories: credentials, config_issues, crypto_material. &lsquo;all&rsquo; for everything.</small>
            </div>
            {% endif %}

            {% if show_version_fields %}
            <div class="form-group">
                <label for="pre-bv">Baseline version</label>
                <div class="version-picker-row">
                    <select id="pre-bv-project" class="version-picker-select">
                        <option value="">(pick a project)</option>
                    </select>
                    <select id="pre-bv-version" class="version-picker-select" disabled>
                        <option value="">(select project first)</option>
                    </select>
                </div>
                <input type="text" id="pre-bv" name="baseline_version"
                       value="{{ state.get('baseline_version', '') }}"
                       placeholder="Or paste version ID directly">
            </div>
            <div class="form-group">
                <label for="pre-cv">Current version</label>
                <div class="version-picker-row">
                    <select id="pre-cv-project" class="version-picker-select">
                        <option value="">(pick a project)</option>
                    </select>
                    <select id="pre-cv-version" class="version-picker-select" disabled>
                        <option value="">(select project first)</option>
                    </select>
                </div>
                <input type="text" id="pre-cv" name="current_version"
                       value="{{ state.get('current_version', '') }}"
                       placeholder="Or paste version ID directly">
            </div>
            {% endif %}
        </details>

        {% if show_ai %}
        <!-- AI Settings -->
        <details open class="form-section">
            <summary class="form-section-title">AI Settings</summary>
            <div class="form-group form-row">
                <label for="pre-ai">Enable AI</label>
                <label class="toggle">
                    <input type="checkbox" id="pre-ai" name="ai"
                           {% if state.get('ai') %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="form-group">
                <label for="pre-ai-depth">AI depth</label>
                <select id="pre-ai-depth" name="ai_depth">
                    <option value="summary" {% if state.get('ai_depth', 'summary') == 'summary' %}selected{% endif %}>Summary</option>
                    <option value="full" {% if state.get('ai_depth') == 'full' %}selected{% endif %}>Full</option>
                </select>
            </div>
            <div class="form-group form-row">
                <label for="pre-ai-prompts">Export AI prompts</label>
                <label class="toggle">
                    <input type="checkbox" id="pre-ai-prompts" name="ai_prompts"
                           {% if state.get('ai_prompts') %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </details>
        {% endif %}

        <div class="prerun-actions">
            <button type="button" class="btn btn-primary" id="btn-run-submit">Run</button>
            <button type="button" class="btn btn-default prerun-close">Cancel</button>
        </div>
    </form>
</div>
