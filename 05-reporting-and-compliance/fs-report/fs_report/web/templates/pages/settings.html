{% extends "base.html" %}

{% block title %}Settings â€” Finite State Report Kit{% endblock %}

{% block content %}
{% include "components/_dir_browser.html" %}
{% include "components/_scope_dropdowns.html" %}

<div class="settings-page" x-data="settingsForm()">
    <h2>Settings</h2>

    <form id="settings-form" @submit.prevent="saveSettings()">
        <input type="hidden" name="_csrf" value="{{ nonce }}">

        <!-- Connection (read-only) -->
        <details open class="form-section">
            <summary class="form-section-title">Connection</summary>
            <div class="form-group">
                <label>Domain</label>
                <div class="form-static">{{ state.domain or '(not set)' }} <span class="form-hint">(from env)</span></div>
            </div>
            <div class="form-group">
                <label>Token</label>
                <div class="form-static">{{ token_display }} <span class="form-hint">(from env)</span></div>
            </div>
        </details>

        <!-- Operational Defaults -->
        <details open class="form-section">
            <summary class="form-section-title">Operational Defaults</summary>
            <div class="form-group">
                <label for="cfg-output">Default output directory</label>
                <div class="input-with-btn">
                    <input type="text" id="cfg-output" name="output_dir"
                           value="{{ state.get('output_dir', './output') }}">
                    <button type="button" id="cfg-output-browse" class="btn btn-sm btn-default">Browse</button>
                </div>
            </div>
            <div class="form-group">
                <label for="cfg-period">Default period</label>
                <input type="text" id="cfg-period" name="period"
                       value="{{ state.get('period', '30d') }}">
            </div>
            <div class="form-group form-row">
                <label for="cfg-overwrite">Default overwrite</label>
                <label class="toggle">
                    <input type="checkbox" id="cfg-overwrite" name="overwrite"
                           {% if state.get('overwrite') %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="form-group">
                <label for="cfg-cache-ttl">Cache TTL (hours, 0=off)</label>
                <input type="text" id="cfg-cache-ttl" name="cache_ttl"
                       value="{{ state.get('cache_ttl', '4') }}">
            </div>
            <div class="form-group form-row">
                <label for="cfg-verbose">Verbose logging</label>
                <label class="toggle">
                    <input type="checkbox" id="cfg-verbose" name="verbose"
                           {% if state.get('verbose') %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="form-group">
                <label for="cfg-logo">Report logo</label>
                <input type="text" id="cfg-logo" name="logo"
                       value="{{ state.get('logo', '') }}"
                       placeholder="e.g. company-logo.png">
                <small class="form-hint">PNG, SVG, JPG, or WebP from ~/.fs-report/logos/. Max 500KB recommended. Leave empty for default Finite State logo.</small>
            </div>
        </details>

        <!-- Cache Management -->
        <details open class="form-section">
            <summary class="form-section-title">Cache Management</summary>
            <div class="cache-info" id="cache-info-display">
                <div class="cache-stat">
                    <span class="cache-label">Location</span>
                    <span class="cache-value">{{ cache_info.location }}</span>
                </div>
                <div class="cache-stat">
                    <span class="cache-label">API Cache</span>
                    <span class="cache-value">{{ cache_info.api_size_mb }} MB, {{ cache_info.api_entries }} entries{% if cache_info.domain_dbs %} ({{ cache_info.domain_dbs | length }} domain{{ 's' if cache_info.domain_dbs | length != 1 }}){% endif %}</span>
                </div>
                <div class="cache-stat">
                    <span class="cache-label">NVD Cache</span>
                    <span class="cache-value">{{ cache_info.nvd_size_mb }} MB, {{ cache_info.nvd_entries }} entries</span>
                </div>
                <div class="cache-stat">
                    <span class="cache-label">AI Remediation Cache</span>
                    <span class="cache-value">{{ cache_info.ai_size_mb }} MB, {{ cache_info.ai_entries }} entries</span>
                </div>
            </div>
            <div class="form-actions-row">
                <button type="button" class="btn btn-warning btn-sm"
                        hx-delete="/api/settings/cache/api"
                        hx-swap="none"
                        @htmx:after-request="handleCacheClear($event, 'API cache')">
                    Clear API Cache
                </button>
                <button type="button" class="btn btn-warning btn-sm"
                        hx-delete="/api/settings/cache/nvd"
                        hx-swap="none"
                        @htmx:after-request="handleCacheClear($event, 'NVD cache')">
                    Clear NVD Cache
                </button>
                <button type="button" class="btn btn-warning btn-sm"
                        hx-delete="/api/settings/cache/ai"
                        hx-swap="none"
                        @htmx:after-request="handleCacheClear($event, 'AI cache')">
                    Clear AI Cache
                </button>
            </div>
        </details>

        <!-- Assessment Defaults -->
        <details open class="form-section">
            <summary class="form-section-title">Assessment Defaults</summary>
            <div class="form-group">
                <label for="cfg-folder">&#128193; Default folder filter</label>
                <select id="cfg-folder" name="folder_filter"
                        data-value="{{ state.get('folder_filter', '') }}">
                    <option value="">(all folders)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="cfg-project">&#128196; Default project filter</label>
                <select id="cfg-project" name="project_filter"
                        data-value="{{ state.get('project_filter', '') }}">
                    <option value="">(all projects)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="cfg-version">&#127991; Default version filter</label>
                <select id="cfg-version" name="version_filter"
                        data-value="{{ state.get('version_filter', '') }}">
                    <option value="">(all versions)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="cfg-ft">Default finding types</label>
                <input type="text" id="cfg-ft" name="finding_types"
                       value="{{ state.get('finding_types', 'cve') }}"
                       placeholder="cve, sast, credentials">
                <small class="form-hint">Types: cve, sast, thirdparty, binary_sca, source_sca. Categories: credentials, config_issues, crypto_material. Use &lsquo;all&rsquo; for everything.</small>
            </div>
            <div class="form-group form-row">
                <label for="cfg-cvo">Current version only</label>
                <label class="toggle">
                    <input type="checkbox" id="cfg-cvo" name="current_version_only"
                           {% if state.get('current_version_only', True) %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="form-group form-row">
                <label for="cfg-ai">Enable AI</label>
                <label class="toggle">
                    <input type="checkbox" id="cfg-ai" name="ai"
                           {% if state.get('ai') %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="form-group">
                <label for="cfg-ai-depth">AI depth</label>
                <select id="cfg-ai-depth" name="ai_depth">
                    <option value="summary" {% if state.get('ai_depth', 'summary') == 'summary' %}selected{% endif %}>Summary</option>
                    <option value="full" {% if state.get('ai_depth') == 'full' %}selected{% endif %}>Full</option>
                </select>
            </div>
            <div class="form-group form-row">
                <label for="cfg-ai-prompts">Export AI prompts</label>
                <label class="toggle">
                    <input type="checkbox" id="cfg-ai-prompts" name="ai_prompts"
                           {% if state.get('ai_prompts') %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </details>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Settings</button>
            <a href="/" class="btn btn-default">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
var NONCE = '{{ nonce }}';

function settingsForm() {
    return {
        handleCacheClear($event, label) {
            if ($event.detail.successful) {
                this.$dispatch('toast', {message: label + ' cleared', type: 'success'});
                refreshCacheStats();
            } else {
                this.$dispatch('toast', {message: 'Failed to clear ' + label, type: 'error'});
            }
        },
        saveSettings() {
            const form = document.getElementById('settings-form');
            const formData = new FormData(form);
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'X-FS-Session': '{{ nonce }}' },
                body: formData,
            })
            .then(r => r.json())
            .then(data => {
                window.dispatchEvent(new CustomEvent('toast', {
                    detail: { message: 'Settings saved', type: 'success' }
                }));
            })
            .catch(() => {
                window.dispatchEvent(new CustomEvent('toast', {
                    detail: { message: 'Failed to save settings', type: 'error' }
                }));
            });
        },
    };
}

function refreshCacheStats() {
    fetch('/api/settings/cache', { headers: { 'X-FS-Session': NONCE } })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        var el = document.getElementById('cache-info-display');
        if (!el) return;
        var domainNote = d.domain_dbs && d.domain_dbs.length
            ? ' (' + d.domain_dbs.length + ' domain' + (d.domain_dbs.length !== 1 ? 's' : '') + ')'
            : '';
        el.innerHTML =
            '<div class="cache-stat"><span class="cache-label">Location</span><span class="cache-value">' + d.location + '</span></div>' +
            '<div class="cache-stat"><span class="cache-label">API Cache</span><span class="cache-value">' + d.api_size_mb + ' MB, ' + d.api_entries + ' entries' + domainNote + '</span></div>' +
            '<div class="cache-stat"><span class="cache-label">NVD Cache</span><span class="cache-value">' + d.nvd_size_mb + ' MB, ' + d.nvd_entries + ' entries</span></div>' +
            '<div class="cache-stat"><span class="cache-label">AI Remediation Cache</span><span class="cache-value">' + d.ai_size_mb + ' MB, ' + d.ai_entries + ' entries</span></div>';
    });
}

/* Init directory browser + scope dropdowns */
initDirBrowser('cfg-output', 'cfg-output-browse');
initScopeDropdowns({
    projectId: 'cfg-project',
    folderId: 'cfg-folder',
    versionId: 'cfg-version',
});
</script>
{% endblock %}
